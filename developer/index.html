<!--Made by Daniel Nogueira(daniel@leafcomputer.com.br or danielnogueira97@gmail.com)-->
<html>
<head>
	<title>LeafDev</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name = "viewport" content = "initial-scale = 0.75, user-scalable = no">
    <link rel="apple-touch-icon-precomposed" href="icon.png"/>
	<link rel="stylesheet" href="main.css" type="text/css"/>
	<script src="sjcl.js"></script>
	<script src="filedropper.js"></script>
	<script src="socket.io.js"></script>
	<script src="FileSaver.min.js"></script>
	<script>
	ChatServerAddress = "http://leafdev.hp.af.cm/";
	ontitle = false;
	hasFocus = false;
	FilesToUpload = new Array();
	FilesToDownload = new Array();
	nextid = -1;
	FSIDCallbacks = new Array();
	DebugMode = false;
	
	function Debug(message)
	{
	if(DebugMode == true)
	{
		console.log(message);
		return true;
	}
	else
	{
		return false;
	}
	}
	
	function Connect(name)
	{
	socket = io.connect(ChatServerAddress);
	Debug(socket);
	document.getElementById("Connect").style.pointerEvents = "none";
	socket.emit('set user', name);
	
	socket.on('SuccessfulLogin', function () {
	//Load Chat Elements
        Name.style.opacity = "0";
		Name.style.top = "40%";
		Name.disabled = true;
		Password.style.opacity = "0";
		Password.style.top = "40%";
		Password.disabled = true;
		Join.style.top = "40%";
		Join.style.opacity = "0";
		document.getElementById("Connect").style.opacity = "0";
		Chat.style.opacity = "1";
		msgcomposer.disabled = false;
		dnd = new DnDFileController('body', function(files) {
				if(confirm("Are you sure you want to send this(these) file(s)?"))
				{
				Debug("Accepted to send the files");
    			for (var i = 0, f; f = files[i]; i++) {
    			Debug("ooh, a file, how fancy!")
						
						FilesToUpload.push(new FileToUpload(f));
						
      				
      				}
      			}
	  			});
	});
	
	socket.on('LoginError', function () {
	ShowElement('name');
        Name.style.color = "f00";
	});
	
	socket.on('msg', function (message) {
	//Load message
	Debug(message.message);
	TheRow = document.createElement("tr");
	document.getElementById("messages").appendChild(TheRow);
	TheTime = document.createElement("td");
	TheTime.innerText = message.time;
	TheTime.className = "Date";
	TheRow.appendChild(TheTime);
	TheSender = document.createElement("td");
	TheSender.innerText = message.from;
	TheSender.className = "Sender";
	TheRow.appendChild(TheSender);
	TheMessage = document.createElement("td");
	try
	{
		TheMessage.innerText = sjcl.decrypt(Password.value,message.message);
	}
	catch(err)
	{
		if(message.isFile)
		{
			//It is a file
			TheMessage.innerHTML = message.message;
		}
		else
		{
			if(message.from == "Server")
			{
				TheMessage.innerText = message.message;
			}
			else
			{
				TheMessage.innerText = "(Message encrypted with different password)";
			}
		}
	}
	TheMessage.className = "LaMensaje";
	TheRow.appendChild(TheMessage);
	ScrollToBottom();
	});
	
	socket.on("Chunk", function(TheData){
		Debug(TheData);
		if(TheData.data != "")
		{
			FSIDRedirect(TheData.Fid).data += TheData.data;
			socket.emit("more data",{Sid:TheData.Sid,Fid:TheData.Fid,downloaded:TheData.Downloaded})
		}
		else
		{
			//Dowload Complete
			FSIDRedirect(TheData.Fid).conclude();
		}
	});
	
		socket.on("more data", function(TheFid){
		Debug("Server is requesting more chunks of file");
		FSIDRedirect(TheFid).SendBuffer();
	});
	
	}
	

	
	
	function Load()
	{
		title.style.opacity = "1";
		title.style.top = "50%";
		ontitle = true;
		var ua = navigator.userAgent.toLowerCase();
		msgcomposer.disabled = true;
		if (ua.indexOf('safari')!=-1){ 
		if(ua.indexOf('chrome')  > -1)
		{
			//chrome
		}
		else
		{
			//safari
			Name.value = "Name";
			Password.value = "pass";
		}
	}
	}
	
	function LoadNameInput()
	{
		title.style.opacity = "1";
		title.style.top = "35%";
		ontitle = false;
		Name.style.opacity = "1";
		Name.style.top = "50%";
		Name.focus();
	}
	
	function FocusForm(which)
	{
	Debug("focus on " + which);
	if(which == "name")
	{
		Password.style.opacity = "0";
		Password.style.top = "60%";
		Name.style.opacity = "1";
		Name.style.top = "50%";
		Join.style.top = "60%";
		Join.style.opacity = "0";
		Name.style.pointerEvents = "auto";
		Password.style.pointerEvents = "none";
		Join.style.pointerEvents = "none";
		Name.focus();
	}
	else if(which == "password")
	{
		Name.style.opacity = "0";
		Name.style.top = "40%";
		Password.style.opacity = "1";
		Password.style.top = "50%";
		Join.style.top = "60%";
		Join.style.opacity = "0";
		Name.style.pointerEvents = "none";
		Password.style.pointerEvents = "auto";
		Join.style.pointerEvents = "none";
		Password.focus();
	}
	else if(which == "join")
	{
		Name.style.opacity = "0";
		Name.style.top = "40%";
		Password.style.opacity = "0";
		Password.style.top = "40%";
		Join.style.top = "50%";
		Join.style.opacity = "1";
		Name.style.pointerEvents = "none";
		Password.style.pointerEvents = "none";
		Join.style.pointerEvents = "auto";
	}
	}
	
	function DownloadFile(WhichSid)
	{
		var newFTD = FilesToDownload[FilesToDownload.length] = new Object();
		Debug(newFTD);
		socket.emit("DownloadFile", {Sid:WhichSid,Fid:NewFSID(newFTD),downloaded:0});
		newFTD.data = "";
		newFTD.Fdata = new Uint8Array();
		
		socket.on("FileInfo", function(TheData){
			newFTD.Filetype = TheData.TheType;
			newFTD.FileName = TheData.TheName;
		});
		
		newFTD.conclude = function(){
		
		var Place = 0;
		newFTD.Worker = new Worker('EncryptFile.js');
          				newFTD.Worker.addEventListener('message', function(e) {

    						if(e.data['status'] == "debug")
    						{
    						 Debug("File decrypt debug:" + e.data['message']);
    						}
    						else if(e.data['status'] == "error")
    						{
    						Debug("Error on file decryption, here's message: " + e.data['message']);
    						}
    						else if(e.data['status'] == "begin")
    						{
    							newFTD.Worker.postMessage({cmd: "more data"});
    						}
    						else if(e.data['status'] == "CryptChunk")
    						{
    							if(e.data['data'].length != 0)
    							{
    							for(i=0;i<e.data['data'].length;i++)
    							{
    							newFTD.Fdata[e.data['data'].place+i] = e.data['data'][i];
    							}
    							newFTD.Worker.postMessage({cmd: "more data"});
    							}
    							else
    							{
    							Debug("It's decrypted!!");
								Debug(newFTD.Fdata);
								
								newFTD.TheFileBlob = new Blob([newFTD.Fdata],{type: newFTD.Filetype});
								saveAs(newFTD.TheFileBlob, newFTD.FileName);
    							}
    						}
    						else if(e.data['status'] == "more data")
    						{
    							newFTD.Worker.postMessage({cmd: "Chunk", data: newFTD.data.substring(Place*100000,(Place+1)*100000)});
    							Place++;
    						}
						}, false);
						newFTD.Worker.postMessage({password: Password.value, cmd: "decrypt"});
						
						
		}
		
	}
	
	function FSIDRedirect(whichFSID)
	{
		return FSIDCallbacks[whichFSID];
	}
	
	function NewFSID(callback)
	{
		nextid++;
		FSIDCallbacks[nextid] = callback;
		return nextid;
	}
	
	function FileToUpload(f)
	{
		this.Fid = NewFSID(this);
		var that = this;
		this.reader = new FileReader();
		
		//Set the HTML tags
		this.UploadBox = document.createElement("div");
		this.UploadBox.className = "UploadFile";
		UploadFilesContainer.appendChild(this.UploadBox);
		this.UploadBox.TheTitle = document.createElement("div");
		this.UploadBox.appendChild(this.UploadBox.TheTitle);
		this.UploadBox.TheStatus = document.createElement("div");
		this.UploadBox.appendChild(this.UploadBox.TheStatus);
		this.UploadBox.TheProgress = document.createElement("progress");
		this.UploadBox.TheProgress.max = "100";
		this.UploadBox.TheProgress.value = "0";
		this.UploadBox.appendChild(this.UploadBox.TheProgress);
		this.UploadBox.TheCancelButton = document.createElement("button");
		this.UploadBox.TheCancelButton.className = "FileUploadBtn";
		this.UploadBox.TheCancelButton.innerText = "Cancel";
		this.UploadBox.appendChild(this.UploadBox.TheCancelButton);
		
		this.FileSize = 1;
		this.Sent = 0;
		this.File = f;
		this.EncryptedFile = new Array();
		//Place to send to worker...
		var Place = 0;
		
     					 this.reader.onerror = function(){
     					 	//Display error
     					 	Debug("There was an error on reading file...");
     					 };
     					 
     					 this.UploadBox.TheCancelButton.onclick = function()
						{
							that.reader.abort();	
						}
     					 
    					 this.reader.onprogress = function(evt){
    					 if (evt.lengthComputable) {
							var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
								that.UploadBox.TheProgress.value = percentLoaded;
							}
    					 	
    					 };
    					 
    					 this.reader.onabort = function(e) {
      					 Debug('File read cancelled');
      					 that.UploadBox.removeChild(that.UploadBox.TheCancelButton);
      					 that.UploadBox.removeChild(that.UploadBox.TheProgress);
      					 that.UploadBox.removeChild(that.UploadBox.TheStatus);
      					 that.UploadBox.removeChild(that.UploadBox.TheTitle);
      					 UploadFilesContainer.removeChild(that.UploadBox);
    					 };
    					 
    					 this.AllDone = function() {
    					 Debug('Deleting File Upload object...');
    					 that.UploadBox.removeChild(that.UploadBox.TheCancelButton);
      					 that.UploadBox.removeChild(that.UploadBox.TheProgress);
      					 that.UploadBox.removeChild(that.UploadBox.TheStatus);
      					 that.UploadBox.removeChild(that.UploadBox.TheTitle);
      					 UploadFilesContainer.removeChild(that.UploadBox);
      					 that = null;
      					 Debug("File Upload object deleted");
    					 }
    					 
    					 this.reader.onloadstart = function(e) {
      					 that.UploadBox.TheTitle.innerText = that.File.name;
      					 that.UploadBox.TheStatus.innerText = "Loading file...";
    					 };
    					 
    					 this.SendBuffer = function()
    					 {
    					 	socket.emit("Chunk",{Fid: that.Fid, data: that.EncryptedFile[0]});
    					 	that.UploadBox.TheStatus.innerText = "Sending...";
    					 	this.Sent += that.EncryptedFile[0].length;
    					 	var percentLoaded = (this.Sent/this.FileSize)*100;
    					 	that.UploadBox.TheProgress.value = percentLoaded;
    					 	Debug("Sent a chunk of file to server...");
    					 	if(that.EncryptedFile[0] == "")
    					 	{
    					 	that.AllDone();
    					 	}
    					 	else
    					 	{
    					 	that.EncryptedFile.splice(0,1);
    					 	}
    					 }
    					 
    					 
						
     					 // Closure to capture the file information.
      					this.reader.onload = (function(theFile) {
      					that.UploadBox.TheStatus.innerText = "Encrypting...";
      					Debug("hmm, this might work...")
        				return function(e) {
        				Debug("Well, it should send to server...")
          				//encrypt, then send to server.
          				that.Worker = new Worker('EncryptFile.js');
          				that.Worker.addEventListener('message', function(e) {
    						//send e to server
    						//socket.emit
    						if(e.data['status'] == "ok")
    						{
    						that.EncryptedFile = e.data['data'];
    						Debug(that.EncryptedFile);
    						}
    						else if(e.data['status'] == "debug")
    						{
    						 Debug("File encrypt debug:" + e.data['message']);
    						}
    						else if(e.data['status'] == "error")
    						{
    						Debug("Error on file encryption, here's message: " + e.data['message']);
    						}
    						else if(e.data['status'] == "begin")
    						{
    							that.FileSize = e.data['data'];
    							socket.emit('NewFile', {TheID: that.Fid, TheTitle: that.File.name, TheType: that.File.type});
    							Debug("It began getting encrypted file from worker and uploading to server process");
    							that.Worker.postMessage({cmd: "more data"});
    						}
    						else if(e.data['status'] == "CryptChunk")
    						{
    							if(e.data['data'] != "")
    							{
    							//that.EncryptedFile += e.data['data'];
    							//socket.emit("Chunk",{Fid: that.Fid, data: e.data['data']});
    							that.EncryptedFile.push(e.data['data']);
    							Debug("Received Encrypted chunk from worker");
    							that.Worker.postMessage({cmd: "more data"});
    							}
    							else
    							{
    							//Send one last chunk (empty), so server knows that file is finished transferring...
    							//socket.emit("Chunk",{Fid: that.Fid, data: ""})
    							that.EncryptedFile.push(e.data['data']);
    							Debug("It's encrypted!!");
    							}
    						}
    						else if(e.data['status'] == "more data")
    						{
    							that.Worker.postMessage({cmd: "Chunk", data: that.reader.result.substring(Place*100000,(Place+1)*100000)});
    							Place++;
    						}
						}, false);
						that.Worker.postMessage({password: Password.value, cmd: "encrypt"});
          				//this.EncryptedFile = sjcl.encrypt(Password.value, e.target.result)
        				};
     				 	})(f);

     					 // Read the file as a data URL.
      				this.reader.readAsBinaryString(f);
	}
	
	function ShowElement(which)
	{
	if(which == "password")
        {
        Password.style.opacity = "1";
        Password.style.pointerEvents = "auto";
		}
	else if(which == "name")
        {
        Name.style.opacity = "1";
        Name.style.pointerEvents = "auto";
		}
	else if(which == "join")
        {
        Join.style.opacity = "1";
        Join.style.pointerEvents = "auto";
		}
        }

        function HideElement(which)
		{
	if(which == "password")
        {
        Password.style.opacity = "0";
		}
	else if(which == "name")
        {
        Name.style.opacity = "0";
		}
	else if(which == "join")
        {
        Join.style.opacity = "0";
		}
        }
        
        function ShowPrevious()
        {
        	if(Password.style.top == "50%")
        	{
        		ShowElement('name');
        	}
        	else if(Join.style.top == "50%")
        	{
        		ShowElement('password');
        	}
        }
        
        function ScrollToBottom()
        {
			document.getElementById("msgcontainer").scrollTop = document.getElementById("msgcontainer").scrollHeight;
        }
        
        function OnKeyUpPass(e) {
        if (e.keyCode == 13) {
		Connect(Name.value)
    }
}
	</script>
	
</head>
<body id="TheBody" onload="setTimeout('Load()', 1000)" onmousemove="if(ontitle){LoadNameInput()}" ontouchend="if(ontitle){LoadNameInput()}">
	<div id="Connect">
		<h1 id="title" onclick="ShowPrevious()" onmouseover="ShowPrevious()">LeafDev</h1>
		<input onfocus="FocusForm('name')" onblur="FocusForm('password')" id="Name" class="logininput" oninput="if(Name.value != ''){ShowElement('password');}else{ HideElement('password');}" placeholder="Name">
		<input id="Password" onfocus="FocusForm('password')" onblur="FocusForm('join')" type="password" class="logininput" onkeyup="OnKeyUpPass(event)" oninput="if(Password.value != ''){ShowElement('join');HideElement('name');}else{ HideElement('join');}" placeholder="Password">
		<button id="Join" onclick="Connect(Name.value);">Join</button>
	</div>
	<div id="Chat">
		<span id="UserIndicator"></span>
		<div id="msgcontainer">
		<table id="messages">
		</table>
		</div>
		<input placeholder="Type the Message here..." id="msgcomposer" type="search" onsearch="socket.emit('msg', sjcl.encrypt(Password.value, this.value));this.value = '';this.focus();ScrollToBottom();">
	</div>
	<div id="UploadFilesContainer">
		
	</div>
</body>
</html>